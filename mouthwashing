#!/usr/bin/env python3

import sys
import os
import subprocess
import shutil

def play_audio_file(filepath):
    """Play an audio file using available system audio players"""
    players = ['aplay', 'paplay', 'ffplay', 'mpv', 'vlc']
    
    for player in players:
        if shutil.which(player):
            try:
                if player == 'ffplay':
                    # ffplay requires -nodisp to run without video window and -autoexit to close after playing
                    subprocess.run([player, '-nodisp', '-autoexit', filepath], 
                                 stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                elif player == 'vlc':
                    # VLC requires --intf dummy to run headless and --play-and-exit to close after playing
                    subprocess.run([player, '--intf', 'dummy', '--play-and-exit', filepath],
                                 stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                else:
                    subprocess.run([player, filepath], 
                                 stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                return True
            except subprocess.CalledProcessError:
                continue
    
    print(f"Error: No suitable audio player found. Please install one of: {', '.join(players)}")
    return False

def main():
    # Dictionary mapping track numbers to song names
    song_names = {
        1: "Main Theme",
        2: "Just Cargo",
        3: "Medium Rare",
        4: "The Windows Are Plastic",
        5: "Absolute Travesty",
        6: "Lofty Ambitions",
        7: "Here, On Earth",
        8: "Dragonbreath Theme",
        9: "Like A Cyst",
        10: "Bad News",
        11: "And There It Is",
        12: "The Patience Runs",
        13: "Thinking About It Too",
        14: "Wake Rock",
        15: "Giving Up",
        16: "Banter",
        17: "What's New On The Radio",
        18: "Useless",
        19: "Polle Says",
        20: "For Old Times Sake",
        21: "In Control",
        22: "No Reason",
        23: "I Told Him",
        24: "Who Is The Birthday Boy",
        25: "Facing Responsibility",
        26: "Event",
        27: "Confrontation",
        28: "Speech! Speech! Speech!",
        29: "Heroes",
        30: "Stretch Marks",
        31: "Come To Daddy",
        32: "God's Favorites",
        33: "The End (Bonus Track)"
    }
    
    if len(sys.argv) == 1:
        # No arguments provided
        print("hello world")
        return
    
    if len(sys.argv) >= 2 and sys.argv[1] == "ost":
        if len(sys.argv) < 3:
            print("Error: Please provide a track number after 'ost'")
            print("Usage: mouthwashing ost <number>")
            print("       mouthwashing ost --help")
            return
        
        # Check for help flag
        if sys.argv[2] == "--help":
            print("Mouthwashing OST - Available Tracks:")
            print("=" * 50)
            for track_num, song_name in song_names.items():
                print(f"{track_num:2d}. {song_name}")
            print("=" * 50)
            print("Usage: mouthwashing ost <number>")
            print("Example: mouthwashing ost 3")
            return
        
        try:
            track_number = int(sys.argv[2])
        except ValueError:
            print("Error: Track number must be a valid integer")
            print("Use 'mouthwashing ost --help' to see available tracks")
            return
        
        # Check if track number is valid
        if track_number not in song_names:
            print(f"Error: Track {track_number} does not exist. Valid tracks are 1-33.")
            print("Use 'mouthwashing ost --help' to see all available tracks")
            return
        
        # Construct the path to the audio file
        script_dir = os.path.dirname(os.path.abspath(__file__))
        mw_ost_dir = os.path.join(script_dir, "mw_ost")
        audio_file = os.path.join(mw_ost_dir, f"Track {track_number}.wav")
        
        # Check if the directory exists
        if not os.path.exists(mw_ost_dir):
            print(f"Error: Directory 'mw_ost' not found in script directory ({script_dir})")
            return
        
        # Check if the audio file exists
        if not os.path.exists(audio_file):
            print(f"Error: Track {track_number}.wav not found in mw_ost directory")
            return
        
        print(f"Now playing: Track {track_number} | {song_names[track_number]}")
        if not play_audio_file(audio_file):
            print("Failed to play audio file")
        
    else:
        print("Unknown command")
        print("Usage:")
        print("  mouthwashing          - Display hello world")
        print("  mouthwashing ost <n>  - Play Track <n>.wav from mw_ost directory")
        print("  mouthwashing ost --help - Show all available tracks")

if __name__ == "__main__":
    main()
